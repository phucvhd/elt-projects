version: '3.8'

services:
  youtube_trending_postgres:
    image: postgres:latest
    container_name: yt_postgres
    restart: always
    ports:
      - "5432:5432"
    networks:
      - yt_elt_network
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

  airflow-postgres: # This is the PostgreSQL database for Airflow, storing the metadata
    image: postgres:latest
    networks:
      - yt_elt_network
    environment:
      POSTGRES_USER: ${AIRFLOW_USER}
      POSTGRES_PASSWORD: ${AIRFLOW_PASSWORD}
      POSTGRES_DB: ${AIRFLOW_DB}

  airflow-standalone:
      image: apache/airflow:3.0.6
      user: root
      ports:
        - "8080:8080"
      depends_on:
        - airflow-postgres
      networks:
        - yt_elt_network
      volumes:
        - ./airflow/dags:/opt/airflow/dags
        - ./airflow/elt:/opt/airflow/elt
        - ./youtube_trending_dbt:/opt/dbt
        - /var/run/docker.sock:/var/run/docker.sock
      environment:
        AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_USER}:${AIRFLOW_PASSWORD}@${AIRFLOW_HOST}/${AIRFLOW_DB}
        PYTHONPATH: /opt/airflow/elt:/opt/airflow
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        POSTGRES_HOST: ${POSTGRES_HOST}
        POSTGRES_PORT: ${POSTGRES_PORT}
        POSTGRES_DB: ${POSTGRES_DB}
        GOOGLE_API_KEY: ${GOOGLE_API_KEY}
        GOOGLE_DATA_V3_URL: ${GOOGLE_DATA_V3_URL}
        REGION_CODE: ${REGION_CODE}
      command: >
        bash -c "airflow db migrate && airflow standalone"

networks:
  yt_elt_network:
    driver: bridge