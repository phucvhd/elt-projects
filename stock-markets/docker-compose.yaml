version: '3'

services:
  yahoo_finance_postgres:
    image: postgres:latest
    ports:
      - "5434:5432"
    networks:
      - elt_network
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

  airflow-postgres: # This is the PostgreSQL database for Airflow, storing the metadata
    image: postgres:latest
    networks:
      - elt_network
    environment:
      POSTGRES_USER: ${AIRFLOW_USER}
      POSTGRES_PASSWORD: ${AIRFLOW_PASSWORD}
      POSTGRES_DB: ${AIRFLOW_DB}
    volumes:
      - ./airflow/airflow_init.sql:/docker-entrypoint-initdb.d/airflow_init.sql

  init-airflow:
    build: .
    ports:
      - "8081:8080"
    depends_on:
      - airflow-postgres
    networks:
      - elt_network
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./elt:/opt/airflow/elt
      - ./stock_markets_dbt:/opt/dbt
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_USER}:${AIRFLOW_PASSWORD}@${AIRFLOW_HOST}/${AIRFLOW_DB}
      PYTHONPATH: /opt/airflow/elt:/opt/airflow
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      YFINANCE_PERIOD: ${YFINANCE_PERIOD}
      YFINANCE_INTERVAL: ${YFINANCE_INTERVAL}
    command: >
      bash -c "airflow db migrate && airflow standalone"

networks:
  elt_network:
    driver: bridge